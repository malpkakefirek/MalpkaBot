"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = watcher;

var _chokidar = _interopRequireDefault(require("chokidar"));

var _eslint = _interopRequireDefault(require("eslint"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _settings = _interopRequireDefault(require("./settings"));

var _logger = _interopRequireDefault(require("./logger"));

var _clearTerminal = _interopRequireDefault(require("./formatters/helpers/clear-terminal.js"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const logger = (0, _logger.default)('watcher');
logger.debug('Loaded');
const events = {
  change: 'change'
};
const chokidarOptions = {
  ignored: /\.git|node_modules|bower_components/
};
const cliOptionProperties = ['config', 'eslintrc', 'ext', 'parser', 'cache', 'cacheLocation', 'ignore', 'ignorePath', 'ignorePattern', 'fix', 'parserOptions', 'global', 'rule'];
const cliOptionMap = {
  config: 'configFile',
  eslintrc: 'useEslintrc',
  ext: 'extensions',
  cacheFile: 'cacheLocation',
  rule: 'rules'
};

function filterWarnings(results) {
  return _lodash.default.reduce(results, (curr, result) => {
    if (result.warningCount) {
      let newResult = _lodash.default.omit(result, 'messages');

      newResult.messages = _lodash.default.filter(result.messages, m => m.severity > 1);
      curr.push(newResult);
      return curr;
    }

    curr.push(result);
    return curr;
  }, []);
}

function requireFormatter(formatterPath) {
  try {
    return require(formatterPath);
  } catch (ex) {
    ex.message = `There was a problem loading formatter: ${formatterPath}\nError: ${ex.message}`;
    throw ex;
  }
}

function getFormatter(cli, formatter) {
  const pathToFormatterSpecified = formatter.includes('\\');
  const isSimpleFormatter = formatter.includes('simple');
  const formatterPath = formatter.replace(/\\/g, '/');

  if (isSimpleFormatter) {
    logger.debug(`Formatter local: ${formatter}`);
    return requireFormatter(`./formatters/${formatterPath}`);
  } else if (pathToFormatterSpecified) {
    const cwd = process.cwd();
    logger.debug('Formatter user:', formatterPath);

    const location = _path.default.resolve(cwd, formatterPath);

    return requireFormatter(location);
  }

  logger.debug(`Formatter eslint: ${formatter}`);
  return cli.getFormatter(formatter);
} ///https://github.com/eslint/eslint/blob/233440e524aa41545b66b2c3c7ca26fe790e32e0/tests/lib/cli-engine.js#L105-L107


function watcher(options) {
  const cliOptions = (0, _lodash.default)(options).pick(cliOptionProperties).reduce(function (result, value, key) {
    key = cliOptionMap[key] || key;
    result[key] = value;
    return result;
  }, {});
  logger.debug('cli', cliOptions);
  logger.debug('options', options);
  const cli = new _eslint.default.CLIEngine(cliOptions);
  const watchDir = options._.length ? options._ : [_path.default.resolve('./')];
  const formatter = getFormatter(cli, options.format);

  function lintFile(path) {
    logger.debug('lintFile: %s', path);

    if (options.clear) {
      (0, _clearTerminal.default)();
    }

    const report = cli.executeOnFiles(path);

    if (options.fix) {
      _eslint.default.CLIEngine.outputFixes(report);
    }

    const results = _settings.default.cliOptions.quiet ? filterWarnings(report.results) : report.results;
    logger.log(formatter(results));
  }

  function isWatchableExtension(filePath, extensions = cli.options.extensions) {
    const extension = _path.default.extname(filePath);

    const dotExtensions = extensions.map(e => {
      if (!e.match(/^\./)) {
        return `.${e}`;
      }

      return e;
    });
    logger.debug(extension, dotExtensions);

    if (dotExtensions.length > 0) {
      return _lodash.default.includes(dotExtensions, extension);
    } // Use the ESLint default extension, if none is provided


    return _lodash.default.includes(cli.options.extensions, extension);
  }

  _chokidar.default.watch(watchDir, chokidarOptions).on(events.change, function changeEvent(path) {
    logger.debug('Changed:', path);

    if (!cli.isPathIgnored(path) && isWatchableExtension(path, options.ext)) {
      const watchPath = options.changed ? [path] : watchDir;
      lintFile(watchPath);
    }
  }).on('error', logger.error);

  logger.debug('Watching: %o', watchDir);
}

module.exports = exports["default"];
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy93YXRjaGVyLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsImRlYnVnIiwiZXZlbnRzIiwiY2hhbmdlIiwiY2hva2lkYXJPcHRpb25zIiwiaWdub3JlZCIsImNsaU9wdGlvblByb3BlcnRpZXMiLCJjbGlPcHRpb25NYXAiLCJjb25maWciLCJlc2xpbnRyYyIsImV4dCIsImNhY2hlRmlsZSIsInJ1bGUiLCJmaWx0ZXJXYXJuaW5ncyIsInJlc3VsdHMiLCJfIiwicmVkdWNlIiwiY3VyciIsInJlc3VsdCIsIndhcm5pbmdDb3VudCIsIm5ld1Jlc3VsdCIsIm9taXQiLCJtZXNzYWdlcyIsImZpbHRlciIsIm0iLCJzZXZlcml0eSIsInB1c2giLCJyZXF1aXJlRm9ybWF0dGVyIiwiZm9ybWF0dGVyUGF0aCIsInJlcXVpcmUiLCJleCIsIm1lc3NhZ2UiLCJnZXRGb3JtYXR0ZXIiLCJjbGkiLCJmb3JtYXR0ZXIiLCJwYXRoVG9Gb3JtYXR0ZXJTcGVjaWZpZWQiLCJpbmNsdWRlcyIsImlzU2ltcGxlRm9ybWF0dGVyIiwicmVwbGFjZSIsImN3ZCIsInByb2Nlc3MiLCJsb2NhdGlvbiIsInBhdGgiLCJyZXNvbHZlIiwid2F0Y2hlciIsIm9wdGlvbnMiLCJjbGlPcHRpb25zIiwicGljayIsInZhbHVlIiwia2V5IiwiZXNsaW50IiwiQ0xJRW5naW5lIiwid2F0Y2hEaXIiLCJsZW5ndGgiLCJmb3JtYXQiLCJsaW50RmlsZSIsImNsZWFyIiwicmVwb3J0IiwiZXhlY3V0ZU9uRmlsZXMiLCJmaXgiLCJvdXRwdXRGaXhlcyIsInNldHRpbmdzIiwicXVpZXQiLCJsb2ciLCJpc1dhdGNoYWJsZUV4dGVuc2lvbiIsImZpbGVQYXRoIiwiZXh0ZW5zaW9ucyIsImV4dGVuc2lvbiIsImV4dG5hbWUiLCJkb3RFeHRlbnNpb25zIiwibWFwIiwiZSIsIm1hdGNoIiwiY2hva2lkYXIiLCJ3YXRjaCIsIm9uIiwiY2hhbmdlRXZlbnQiLCJpc1BhdGhJZ25vcmVkIiwid2F0Y2hQYXRoIiwi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QUFPZ0YsS0FWdEI7O0FBWUFoRixTQUFPQyxLQUFQLENBQWEsY0FBYixFQUE2Qm1ELFFBQTdCO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY2hva2lkYXIgZnJvbSAnY2hva2lkYXInO1xuaW1wb3J0IGVzbGludCBmcm9tICdlc2xpbnQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuXG5pbXBvcnQgc2V0dGluZ3MgZnJvbSAnLi9zZXR0aW5ncyc7XG5pbXBvcnQgTG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBjbGVhclRlcm1pbmFsIGZyb20gJy4vZm9ybWF0dGVycy9oZWxwZXJzL2NsZWFyLXRlcm1pbmFsLmpzJztcblxuY29uc3QgbG9nZ2VyID0gTG9nZ2VyKCd3YXRjaGVyJyk7XG5cbmxvZ2dlci5kZWJ1ZygnTG9hZGVkJyk7XG5cbmNvbnN0IGV2ZW50cyA9IHsgY2hhbmdlOiAnY2hhbmdlJyB9O1xuY29uc3QgY2hva2lkYXJPcHRpb25zID0ge1xuICBpZ25vcmVkOiAvXFwuZ2l0fG5vZGVfbW9kdWxlc3xib3dlcl9jb21wb25lbnRzLyxcbn07XG5jb25zdCBjbGlPcHRpb25Qcm9wZXJ0aWVzID0gW1xuICAnY29uZmlnJyxcbiAgJ2VzbGludHJjJyxcbiAgJ2V4dCcsXG4gICdwYXJzZXInLFxuICAnY2FjaGUnLFxuICAnY2FjaGVMb2NhdGlvbicsXG4gICdpZ25vcmUnLFxuICAnaWdub3JlUGF0aCcsXG4gICdpZ25vcmVQYXR0ZXJuJyxcbiAgJ2ZpeCcsXG4gICdwYXJzZXJPcHRpb25zJyxcbiAgJ2dsb2JhbCcsXG4gICdydWxlJyxcbl07XG5jb25zdCBjbGlPcHRpb25NYXAgPSB7XG4gIGNvbmZpZzogJ2NvbmZpZ0ZpbGUnLFxuICBlc2xpbnRyYzogJ3VzZUVzbGludHJjJyxcbiAgZXh0OiAnZXh0ZW5zaW9ucycsXG4gIGNhY2hlRmlsZTogJ2NhY2hlTG9jYXRpb24nLFxuICBydWxlOiAncnVsZXMnLFxufTtcblxuZnVuY3Rpb24gZmlsdGVyV2FybmluZ3MocmVzdWx0cykge1xuICByZXR1cm4gXy5yZWR1Y2UoXG4gICAgcmVzdWx0cyxcbiAgICAoY3VyciwgcmVzdWx0KSA9PiB7XG4gICAgICBpZiAocmVzdWx0Lndhcm5pbmdDb3VudCkge1xuICAgICAgICBsZXQgbmV3UmVzdWx0ID0gXy5vbWl0KHJlc3VsdCwgJ21lc3NhZ2VzJyk7XG4gICAgICAgIG5ld1Jlc3VsdC5tZXNzYWdlcyA9IF8uZmlsdGVyKHJlc3VsdC5tZXNzYWdlcywgKG0pID0+IG0uc2V2ZXJpdHkgPiAxKTtcbiAgICAgICAgY3Vyci5wdXNoKG5ld1Jlc3VsdCk7XG4gICAgICAgIHJldHVybiBjdXJyO1xuICAgICAgfVxuICAgICAgY3Vyci5wdXNoKHJlc3VsdCk7XG4gICAgICByZXR1cm4gY3VycjtcbiAgICB9LFxuICAgIFtdXG4gICk7XG59XG5cbmZ1bmN0aW9uIHJlcXVpcmVGb3JtYXR0ZXIoZm9ybWF0dGVyUGF0aCkge1xuICB0cnkge1xuICAgIHJldHVybiByZXF1aXJlKGZvcm1hdHRlclBhdGgpO1xuICB9IGNhdGNoIChleCkge1xuICAgIGV4Lm1lc3NhZ2UgPSBgVGhlcmUgd2FzIGEgcHJvYmxlbSBsb2FkaW5nIGZvcm1hdHRlcjogJHtmb3JtYXR0ZXJQYXRofVxcbkVycm9yOiAke2V4Lm1lc3NhZ2V9YDtcbiAgICB0aHJvdyBleDtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRGb3JtYXR0ZXIoY2xpLCBmb3JtYXR0ZXIpIHtcbiAgY29uc3QgcGF0aFRvRm9ybWF0dGVyU3BlY2lmaWVkID0gZm9ybWF0dGVyLmluY2x1ZGVzKCdcXFxcJyk7XG4gIGNvbnN0IGlzU2ltcGxlRm9ybWF0dGVyID0gZm9ybWF0dGVyLmluY2x1ZGVzKCdzaW1wbGUnKTtcbiAgY29uc3QgZm9ybWF0dGVyUGF0aCA9IGZvcm1hdHRlci5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cbiAgaWYgKGlzU2ltcGxlRm9ybWF0dGVyKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBGb3JtYXR0ZXIgbG9jYWw6ICR7Zm9ybWF0dGVyfWApO1xuXG4gICAgcmV0dXJuIHJlcXVpcmVGb3JtYXR0ZXIoYC4vZm9ybWF0dGVycy8ke2Zvcm1hdHRlclBhdGh9YCk7XG4gIH0gZWxzZSBpZiAocGF0aFRvRm9ybWF0dGVyU3BlY2lmaWVkKSB7XG4gICAgY29uc3QgY3dkID0gcHJvY2Vzcy5jd2QoKTtcblxuICAgIGxvZ2dlci5kZWJ1ZygnRm9ybWF0dGVyIHVzZXI6JywgZm9ybWF0dGVyUGF0aCk7XG4gICAgY29uc3QgbG9jYXRpb24gPSBwYXRoLnJlc29sdmUoY3dkLCBmb3JtYXR0ZXJQYXRoKTtcblxuICAgIHJldHVybiByZXF1aXJlRm9ybWF0dGVyKGxvY2F0aW9uKTtcbiAgfVxuXG4gIGxvZ2dlci5kZWJ1ZyhgRm9ybWF0dGVyIGVzbGludDogJHtmb3JtYXR0ZXJ9YCk7XG5cbiAgcmV0dXJuIGNsaS5nZXRGb3JtYXR0ZXIoZm9ybWF0dGVyKTtcbn1cblxuLy8vaHR0cHM6Ly9naXRodWIuY29tL2VzbGludC9lc2xpbnQvYmxvYi8yMzM0NDBlNTI0YWE0MTU0NWI2NmIyYzNjN2NhMjZmZTc5MGUzMmUwL3Rlc3RzL2xpYi9jbGktZW5naW5lLmpzI0wxMDUtTDEwN1xuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB3YXRjaGVyKG9wdGlvbnMpIHtcbiAgY29uc3QgY2xpT3B0aW9ucyA9IF8ob3B0aW9ucylcbiAgICAucGljayhjbGlPcHRpb25Qcm9wZXJ0aWVzKVxuICAgIC5yZWR1Y2UoZnVuY3Rpb24ocmVzdWx0LCB2YWx1ZSwga2V5KSB7XG4gICAgICBrZXkgPSBjbGlPcHRpb25NYXBba2V5XSB8fCBrZXk7XG4gICAgICByZXN1bHRba2V5XSA9IHZhbHVlO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9LCB7fSk7XG4gIGxvZ2dlci5kZWJ1ZygnY2xpJywgY2xpT3B0aW9ucyk7XG4gIGxvZ2dlci5kZWJ1Zygnb3B0aW9ucycsIG9wdGlvbnMpO1xuICBjb25zdCBjbGkgPSBuZXcgZXNsaW50LkNMSUVuZ2luZShjbGlPcHRpb25zKTtcbiAgY29uc3Qgd2F0Y2hEaXIgPSBvcHRpb25zLl8ubGVuZ3RoID8gb3B0aW9ucy5fIDogW3BhdGgucmVzb2x2ZSgnLi8nKV07XG5cbiAgY29uc3QgZm9ybWF0dGVyID0gZ2V0Rm9ybWF0dGVyKGNsaSwgb3B0aW9ucy5mb3JtYXQpO1xuXG4gIGZ1bmN0aW9uIGxpbnRGaWxlKHBhdGgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ2xpbnRGaWxlOiAlcycsIHBhdGgpO1xuICAgIGlmIChvcHRpb25zLmNsZWFyKSB7XG4gICAgICBjbGVhclRlcm1pbmFsKCk7XG4gICAgfVxuICAgIGNvbnN0IHJlcG9ydCA9IGNsaS5leGVjdXRlT25GaWxlcyhwYXRoKTtcbiAgICBpZiAob3B0aW9ucy5maXgpIHtcbiAgICAgIGVzbGludC5DTElFbmdpbmUub3V0cHV0Rml4ZXMocmVwb3J0KTtcbiAgICB9XG4gICAgY29uc3QgcmVzdWx0cyA9IHNldHRpbmdzLmNsaU9wdGlvbnMucXVpZXQgPyBmaWx0ZXJXYXJuaW5ncyhyZXBvcnQucmVzdWx0cykgOiByZXBvcnQucmVzdWx0cztcblxuICAgIGxvZ2dlci5sb2coZm9ybWF0dGVyKHJlc3VsdHMpKTtcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzV2F0Y2hhYmxlRXh0ZW5zaW9uKGZpbGVQYXRoLCBleHRlbnNpb25zID0gY2xpLm9wdGlvbnMuZXh0ZW5zaW9ucykge1xuICAgIGNvbnN0IGV4dGVuc2lvbiA9IHBhdGguZXh0bmFtZShmaWxlUGF0aCk7XG4gICAgY29uc3QgZG90RXh0ZW5zaW9ucyA9IGV4dGVuc2lvbnMubWFwKChlKSA9PiB7XG4gICAgICBpZiAoIWUubWF0Y2goL15cXC4vKSkge1xuICAgICAgICByZXR1cm4gYC4ke2V9YDtcbiAgICAgIH1cbiAgICAgIHJldHVybiBlO1xuICAgIH0pO1xuXG4gICAgbG9nZ2VyLmRlYnVnKGV4dGVuc2lvbiwgZG90RXh0ZW5zaW9ucyk7XG4gICAgaWYgKGRvdEV4dGVuc2lvbnMubGVuZ3RoID4gMCkge1xuICAgICAgcmV0dXJuIF8uaW5jbHVkZXMoZG90RXh0ZW5zaW9ucywgZXh0ZW5zaW9uKTtcbiAgICB9XG5cbiAgICAvLyBVc2UgdGhlIEVTTGludCBkZWZhdWx0IGV4dGVuc2lvbiwgaWYgbm9uZSBpcyBwcm92aWRlZFxuICAgIHJldHVybiBfLmluY2x1ZGVzKGNsaS5vcHRpb25zLmV4dGVuc2lvbnMsIGV4dGVuc2lvbik7XG4gIH1cblxuICBjaG9raWRhclxuICAgIC53YXRjaCh3YXRjaERpciwgY2hva2lkYXJPcHRpb25zKVxuICAgIC5vbihldmVudHMuY2hhbmdlLCBmdW5jdGlvbiBjaGFuZ2VFdmVudChwYXRoKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ0NoYW5nZWQ6JywgcGF0aCk7XG4gICAgICBpZiAoIWNsaS5pc1BhdGhJZ25vcmVkKHBhdGgpICYmIGlzV2F0Y2hhYmxlRXh0ZW5zaW9uKHBhdGgsIG9wdGlvbnMuZXh0KSkge1xuICAgICAgICBjb25zdCB3YXRjaFBhdGggPSBvcHRpb25zLmNoYW5nZWQgPyBbcGF0aF0gOiB3YXRjaERpcjtcblxuICAgICAgICBsaW50RmlsZSh3YXRjaFBhdGgpO1xuICAgICAgfVxuICAgIH0pXG4gICAgLm9uKCdlcnJvcicsIGxvZ2dlci5lcnJvcik7XG5cbiAgbG9nZ2VyLmRlYnVnKCdXYXRjaGluZzogJW8nLCB3YXRjaERpcik7XG59XG4iXX0=